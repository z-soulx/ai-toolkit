# 更新日志

## v5-planning (2026-01-10) - planning-with-files Integration

### ✅ New Features

1. **完全采用 planning-with-files 3-file 模式**
   - task_plan.md: 跟踪 A-D 工作流阶段
   - notes.md: 记录批次处理发现（可选）
   - image_ledger.md: 最终交付物

2. **工作目录优先**
   - 所有输出文件在工作目录创建
   - 不再在 skill 目录创建 outputs/
   - 脚本默认 --out_dir 改为 "." (工作目录)

3. **声明依赖**
   - metadata 中添加 `dependencies: - planning-with-files`
   - 文档中说明如何遵循 planning-with-files 原则

### 🔄 Breaking Changes

- 默认输出目录从 "outputs" 改为 "." (工作目录)
- 需要手动创建 task_plan.md（遵循 planning-with-files）
- 01_extract_manifest.py: --out_dir 默认值从 "outputs" 改为 "."
- 02_make_batch_prompts.py: --out_dir 默认值从 "outputs/batches" 改为 "batches"

### ⬆️ Migration from v4-safe

1. 删除旧的 outputs/ 文件夹（如果存在）
2. 在工作目录创建 task_plan.md
3. 使用新的默认目录结构

### 🔒 Security

保留 v4-safe 的所有安全特性：
- ✅ --dry-run 预览模式
- ✅ 自动备份机制
- ✅ 数据完整性验证
- ✅ 详细的错误处理

---

## v4-safe (2026-01-10) - 安全加固版本

### 🚨 严重问题修复

1. **修复 update_policy 逻辑错误**
   - 问题：先赋值 AI 生成的描述，然后又用旧值覆盖
   - 影响：AI 生成的描述全部被丢弃
   - 修复：改为先判断是否需要更新，再赋值

2. **修复数据验证缺失**
   - 问题：只检查数量，不检查 src 路径匹配
   - 影响：可能导致图片描述错位
   - 修复：新增 src 路径匹配验证，发现不匹配立即拒绝执行

3. **修复占位符识别不完整**
   - 问题：只识别文件扩展名和路径
   - 影响：常见占位符（如 `img`、`图片`、`640`）无法识别
   - 修复：新增常见占位符列表

### ✅ 新增安全特性

1. **强制预览模式**
   - 新增 `--dry-run` 参数
   - SKILL.md 中强制要求先预览再执行
   - 预览显示前 3 个变更示例

2. **自动备份机制**
   - 执行前自动创建带时间戳的备份文件
   - 格式：`原文件名.backup_20260110_143025.md`
   - 支持 `--no-backup` 参数跳过备份

3. **完整的数据验证**
   - 验证图片数量匹配
   - 验证 src 路径匹配
   - 发现问题立即拒绝执行并报错

4. **健壮的错误处理**
   - 文件不存在检查
   - 编码错误处理
   - 写入失败处理
   - 所有错误返回非零退出码

5. **改进的 HTML 解析**
   - 支持单引号属性
   - 支持无引号属性
   - 更健壮的属性匹配

### 📝 文档更新

1. **SKILL.md 更新**
   - 新增"步骤 4a: 预览变更（必须！）"
   - 新增"步骤 4b: 正式应用补丁"
   - 新增"步骤 5: 验证结果"
   - 更新快速开始示例
   - 强调安全要求

2. **新增 SAFETY_REVIEW.md**
   - 详细的安全审查报告
   - 所有问题的修复说明
   - 推荐的安全工作流程

3. **新增 CHANGELOG.md**
   - 版本更新记录
   - 问题修复详情

### ⚠️ 破坏性变更

无。所有参数保持向后兼容。

### 🔄 迁移指南

从 v3-scripted 升级到 v4-safe：

1. 更新脚本文件（已自动完成）
2. 在工作流程中添加 `--dry-run` 预览步骤
3. 检查备份文件是否正常创建

### 📊 安全等级

- v3-scripted: 🔴 低（存在严重逻辑错误）
- v4-safe: 🟢 高（完整的验证和备份机制）

---

## v3-scripted (2026-01-09)

初始脚本化版本，存在安全问题（已在 v4-safe 中修复）。

---

## 版本命名规则

- `vX-描述`: 主版本号 + 版本特性描述
- 示例：`v4-safe` 表示第 4 版，强调安全特性
