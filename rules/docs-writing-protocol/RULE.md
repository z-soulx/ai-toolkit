# 交互式沉淀写入协议（去躁点版）

> 目标：只有在“明确指定沉淀目标 md 文件”时才写入；写入时只记录“设计/契约/语义的变化”，不把修 bug、重试、风格调整等噪声落进上下文。

---

## 0. 核心原则（两句口诀）

- **写入门槛**：**没点名文件，就不写入**（只在对话里回答）。
- **去躁点**：**纠错不记账；改契约/改流程/改规则/改语义，就记账**。

---

## 1. 写入门槛（Write Gate）

**只有满足任一条件，才允许对 md 文件做持久化更新：**

1) 交互中明确指定目标文件路径  
- 例：`沉淀到 docs/xxx.md` / `update: docs/xxx.md` / “把规则写进 docs/xxx.md”

2) 交互中明确要求“生成/落地到某个文件路径”的文档产物  
- 例：“生成一份 docs-writing-protocol.md”

**否则（未指定目标文件）：**
- 只输出建议/结论/方案在对话中
- 不创建、不修改任何沉淀文件

---

## 2. 目标文件绑定（DocTarget）

当用户第一次点名 `X.md`：

- 设置 `DocTarget = X.md`
- 后续交互默认 **继续更新 DocTarget**（仍遵守去躁点规则）

### 2.1 切换目标
用户显式发出任一指令时切换：

- `switch: Y.md`
- “改沉淀到 Y.md”
- “后续都写到 Y.md”

### 2.2 停止沉淀
用户显式发出任一指令时停止写入：

- `stop writing`
- “停止沉淀”
- “后续不要落地到文件了”

---

## 3. 去躁点判定（是否写入 DocTarget）

### 3.1 不更新（不落 patch / 不改 md）
满足任一条：**不写入 DocTarget**

- 修复编译/语法/单测挂了
- 修正 AI 理解错导致的实现偏差，但**不改变**既定设计
- 重试/提示词调整/代码风格调整/重构不改外部行为

> 口诀：**纠错不记账**（只是把实现拉回到既定设计）

### 3.2 必须更新（至少更新 snapshot；必要时落 patch）
只要满足任意一条：**写入 DocTarget（至少 snapshot）**

1. **对外契约变了**：接口字段、枚举、返回码、回调语义  
2. **流程变了**：状态机、时序、重试策略、库存扣减点、对账口径  
3. **规则变了**：优先级、分支条件、灰度开关含义  
4. **数据含义变了**：字段意义、来源、映射、默认值

> 口诀：**改契约/改流程/改规则/改语义，就记账**

---

## 4. 写入粒度：Snapshot vs Patch vs ADR（可选）

当你已判定“必须更新”（命中契约/流程/规则/数据语义）时，不用纠结写多写少——按下面三层落地即可。

> 定位直觉：
> - snapshot：**当前系统“现在长什么样”**（latest truth）
> - patch：**这次变更“为什么这么改 + 兼容/迁移怎么做”**（可追溯）
> - facts：**长期真相**（术语/边界/通用原则，只存一份）
> - changelog：**给人看的“值得关注的变更清单”**（notable changes，而不是所有细节） :contentReference[oaicite:4]{index=4}

### A. 只改了“当前长什么样”（局部 & 影响面小）

例：字段改名、流程步骤调整，但影响面很小；不涉及新的决策/原则/兼容策略。

✅ **必须：更新 `snapshot.md`**（让当前有效状态匹配）  
🔸 **可选：在 `changelog` 记一行**（如果你希望“可扫读的变更轨迹”） :contentReference[oaicite:5]{index=5}

### B. 改了“设计决策/原则/兼容策略”（需要追溯/可运营）

例：字段换成新来源；流程改成异步；增加兜底/补偿；灰度开关新增含义；重试策略/扣减点/对账口径调整。

✅ **必须：落 `patch` + 追加 `changelog`**（把“决策 + 影响 + 兼容/迁移”讲清楚） :contentReference[oaicite:6]{index=6}  
✅ **同时：更新 `snapshot.md`**（保证当前状态准确）

> patch 重点写“对外可观察/可迁移/可回滚”的内容；不要写排障过程、试错、重构细节。  
> 若属于不兼容/破坏性变更（breaking），必须显式写清兼容策略与迁移路径（对齐 SemVer 的“不兼容 API 变更”原则）。 :contentReference[oaicite:7]{index=7}

### C. 触碰了“长期真相”（术语/边界/通用原则）

例：术语定义变了、系统边界变了、通用幂等策略升级、全局一致性/对账原则变了。

✅ **必须：更新 `facts.md`**（长期真相只存一份）  
🔸 **通常也建议：落 `patch` + `changelog`**（这种变更影响大，强追溯）  
✅ **并确保：`snapshot.md` 同步到最新状态**

### 4.1 什么时候用 ADR（可选，但一旦用就要“少而精”）

当变更属于**重大/不可逆/需要长期解释的决策**（架构选择、关键权衡、跨团队共识），才写 ADR：

- ADR 记录：**Context / Decision / Consequences**（背景、决策、后果/影响） :contentReference[oaicite:8]{index=8}
- ADR 不是 changelog、也不是 patch 的替代；它是“关键决策的理由与后果”的长期存档。 :contentReference[oaicite:9]{index=9}

> 提醒：只修 bug / 纠偏实现 / 重构不改外部行为（纠错不记账）不进入本节的任何落地动作。

---

## 5. 写入格式（强制最小化，避免文档膨胀）

每次对 DocTarget 的写入，默认只允许以下三段（最多 10 行）：

- **What changed**：只写变化点（1~3 条）
- **Why**：一句原因/约束
- **Impact**：对外影响（调用方/数据/兼容性/迁移）

> 额外细节（实现过程、排障、提示词试错、重构细节）一律不写入。

---

## 6. 交互指令约定（推荐）

- 指定写入：`update: path/to/doc.md`
- 切换写入：`switch: path/to/another.md`
- 停止写入：`stop writing`
- 本轮不落地（强制）：`no-record`（即便命中必须更新，也仅在对话说明，不写入文件）

---

## 7. 示例（快速对齐）

### 示例 A：修单测挂了
- 判定：纠错不记账
- 动作：不写入 DocTarget

### 示例 B：回调语义从“至多一次”改成“至少一次”
- 判定：契约/流程变更
- 动作：更新 snapshot；若影响调用方且不可兼容，则追加 patch，必要时 ADR

### 示例 C：字段 `status` 含义从“支付状态”改成“订单状态”
- 判定：数据含义变更（高风险）
- 动作：snapshot + patch（强建议），必要时 ADR

---