# PRD 渐进式维护协议（精简版）

## 触发机制

- `prd: path/to/prd` → 进入 PRD 维护模式，设置 DocTarget
- `prd: path/to/another` → 切换 DocTarget
- `stop prd` → 退出 PRD 维护模式
- `no-record` → 本轮强制不记录

## 文件结构识别

AI 自动识别：

**单文件**：`prd.md`（包含 Facts + Snapshot + Changelog 三个章节）
**多文件**：`facts.md` + `snapshot.md` + `changelog.md`

## 三层结构

### Facts（冻结事实）
- 业务域词典、核心约束、系统边界
- 基本不改，或改得很慢

### Snapshot（当前版本）
- 背景/目标、关键流程、关键规则、关键接口
- 反映"现在长什么样"

### Changelog（变更历史）
- 每次变更只追加
- 格式：日期 + 变更点 + 影响面 + 兼容策略（不超过 10 行）

## 去躁点判定

### 不记账（不更新文档）
- 修复 bug/编译/语法/单测
- 修正 AI 理解错，但不改变既定设计
- 重试/提示词调整/代码风格/重构不改外部行为

### 必须记账（更新文档）
满足任一条：
- 对外契约变了（接口字段、枚举、返回码、回调语义）
- 流程变了（状态机、时序、重试策略、库存扣减点）
- 规则变了（优先级、分支条件、灰度开关含义）
- 数据含义变了（字段意义、来源、映射、默认值）

## 更新策略

| 变更类型 | 更新 Facts | 更新 Snapshot | 追加 Changelog |
|---------|-----------|--------------|---------------|
| 术语/边界/约束变了 | ✅ | ✅ | ✅ |
| 流程/规则/接口变了 | ❌ | ✅ | ✅ |
| 修 bug | ❌ | ❌ | ❌ |

## 单文件更新

在对应章节更新：
```markdown
## Facts（冻结事实）
[如果 Facts 变了，更新这里]

## Snapshot（当前版本）
[如果 Snapshot 变了，更新这里]

## Changelog（变更历史）
- YYYY-MM-DD: [追加新条目]
```

## 多文件更新

分别更新对应文件：
- Facts 变了 → 更新 `facts.md`
- Snapshot 变了 → 更新 `snapshot.md`
- 任何需要记账的变更 → 追加 `changelog.md`

## Changelog 格式

```markdown
## YYYY-MM-DD：变更标题

**变更点**：
- 变更点 1
- 变更点 2

**影响面**：
- 接口/规则/数据/任务/灰度

**兼容策略**：
- 向后兼容/双写/开关/迁移路径
```

总计不超过 10 行。
